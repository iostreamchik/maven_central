name: Android CI

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # Only trigger on version tags like 1.0.0

# Environment variables available to all jobs and steps in this workflow
#env:
  # These secrets need to be set in your GitHub repository settings
  # under Settings > Secrets and variables > Actions
#  OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
#  OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
#  SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
#  SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
#  SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
#  MAVEN_CENTRAL_STAGING_PROFILE_ID: ${{ secrets.MAVEN_CENTRAL_STAGING_PROFILE_ID }}

jobs:
  test:
    runs-on: ubuntu-latest
    if: contains(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v5
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Test Debug
        run: ./gradlew toast:testDebug
      - name: Test Release
        run: ./gradlew toast:testRelease

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Build with Gradle
        run: ./gradlew toast:build

  github_release:
    needs: build
#    if: startsWith(github.ref, 'refs/tags/') && github.ref_name.matches('\d+\.\d+\.\d+')
    runs-on: ubuntu-latest
    permissions:
      contents: write  # This is required for creating releases
    steps:
      - name: Check tag format
        id: check_tag
        run: |
          if [[ ! "${GITHUB_REF_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Tag ${GITHUB_REF_NAME} is not a semantic version, skipping..."
          exit 1
          fi
      - uses: actions/checkout@v5
      - name: Set up JDK 17
        if: success()
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.txt
          draft: false
          prerelease: false
      - name: Publish to GitHub Packages
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew clean && ./gradlew toast:assembleRelease && ./gradlew toast:publish
#      - name: Publish to Maven Central
#        run: |
#          echo "Publishing version: ${GITHUB_REF#refs/tags/v}"
#          ./gradlew publishToMavenCentral --no-parallel --no-daemon
#        env:
#          # These environment variables are used by the maven-publish plugin
#          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
#          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
#          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
#          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
#          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
#          MAVEN_CENTRAL_STAGING_PROFILE_ID: ${{ secrets.MAVEN_CENTRAL_STAGING_PROFILE_ID }}
